#!/usr/bin/env ruby

require 'daemons'
require 'eventmachine'
require 'logger'
require 'yaml'
require_relative '../lib/tweetlr.rb'

begin
  config_file = File.join( Dir.pwd,  'config', 'tweetlr.yml')
  @log_file = File.join( Dir.pwd, 'tweetlrd.log')
  CONFIG = YAML.load_file(config_file)
  TERM = CONFIG['search_term']
  USER = CONFIG['tumblr_username']
  PW   = CONFIG['tumblr_password']
  TIMESTAMP = CONFIG['twitter_timestamp']
  UPDATE_PERIOD = CONFIG['update_period']
  @tweetlr = Tweetlr.new(USER, PW, nil, TIMESTAMP, TERM, config_file)
rescue SystemCallError
  $stderr.puts "Ooops - looks like there is no ./config/tweetlr.yml found. I'm affraid tweetlr won't work properly until you introduced that configuration file."
  exit(1)
end

Daemons.run_proc('tweetlr', :dir_mode => :script, :dir => './', :backtrace => true, :log_output => true) do
  #@log = Logger.new(@log_file)
  puts('starting tweetlr daemon...')
  puts "creating a new tweetlr instance using this config: #{CONFIG.inspect}"   
  EventMachine::run { 
    EventMachine::add_periodic_timer( UPDATE_PERIOD ) {
     puts 'starting tweetlr crawl...'
     response = @tweetlr.lazy_search_twitter
     tweets = response['results']
     if tweets
     tweets.each do |tweet|
         tumblr_post = @tweetlr.generate_tumblr_photo_post tweet
         if tumblr_post.nil? ||  tumblr_post[:source].nil?
            puts "could not get image source: tweet: #{tweet} --- tumblr post: #{tumblr_post.inspect}"
       else
           #@log.debug tumblr_post
           #@log.debug @tweetlr.post_to_tumblr tumblr_post
           #puts "tumblr post: #{tumblr_post}"
           res = @tweetlr.post_to_tumblr tumblr_post
           #puts "tumblr response: #{res.header_str} #{res.body_str}"
         end
       end
     end
     puts('finished tweetlr crawl.')
     }
   }

end

